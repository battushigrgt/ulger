<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–•–∞–π—á –ß—É–ª—É—É –î–∞–∞–≤—É—É - –û–Ω–ª–∞–π–Ω</title>
   <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <!-- Auth logic -->
  <script src="../auth.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
      background: #f0f0f0;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
    }
    button {
      font-size: 5em;
      padding: 20px 40px;
      margin: 15px;
      cursor: pointer;
      border-radius: 15px;
      border: none;
      background: #4caf50;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    #status {
      font-size: 1.2em;
      margin: 20px;
      font-weight: bold;
    }
    #result {
      margin-top: 25px;
      font-size: 1.5em;
      font-weight: bold;
    }
    a.back-btn {
      display: inline-block;
      margin-top: 30px;
      padding: 12px 30px;
      background: #4caf50;
      color: white;
      text-decoration: none;
      font-weight: bold;
      border-radius: 30px;
    }
  </style>
</head>
<body>
  <h1>üéÆ –•–∞–π—á –ß—É–ª—É—É –î–∞–∞–≤—É—É - –û–Ω–ª–∞–π–Ω</h1>
  <div id="status">–¢–æ–≥–ª–æ–≥—á —Ö–∞–π–∂ –±–∞–π–Ω–∞...</div>

  <div id="choices" style="display:none;">
    <button data-choice="rock">ü™®</button>
    <button data-choice="paper">üìÑ</button>
    <button data-choice="scissors">‚úÇÔ∏è</button>
  </div>

  <div id="result"></div>

  <a class="back-btn" href="/home.html">–ë–£–¶–ê–•</a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Firebase config - —á–∏ ”©”©—Ä–∏–π–Ω config-–æ–æ —ç–Ω–¥ –æ—Ä—É—É–ª
    const firebaseConfig = {
      apiKey: "AIzaSyDcQ4qCfrGuPJ9Nu7r9snQHM9_b7cp3ZzY",
      authDomain: "rps-online-c6862.firebaseapp.com",
      databaseURL: "https://rps-online-c6862-default-rtdb.firebaseio.com",
      projectId: "rps-online-c6862",
      storageBucket: "rps-online-c6862.firebasestorage.app",
      messagingSenderId: "879021175823",
      appId: "1:879021175823:web:11f69fc2305a8a2d1a1f7a",
      measurementId: "G-LYPNQHNJJT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let playerId = Math.random().toString(36).slice(2, 10);
    let gameId = null;
    let isPlayer1 = false;

    const statusEl = document.getElementById("status");
    const choicesEl = document.getElementById("choices");
    const resultEl = document.getElementById("result");

    // –¢–æ–≥–ª–æ–≥—á —Ö–∞–π—Ö
    async function findGame() {
      const queueRef = ref(db, "queue");
      let queueSnap = null;

      // –ù—ç–≥–¥—Å—ç–Ω —à–∞–ª–≥–∞—Ö
      queueSnap = await (await db).ref ? await (await db).ref(queueRef.path) : null;

      const snapshot = await new Promise(resolve => onValue(queueRef, resolve, { onlyOnce: true }));

      const queue = snapshot.val();

      if (!queue) {
        // Queue —Ö–æ–æ—Å–æ–Ω –±–æ–ª ”©”©—Ä–∏–π–≥”©”© –Ω—ç–º—ç—Ö
        const newQueueRef = push(queueRef);
        await set(newQueueRef, { playerId });
        isPlayer1 = true;

        // –•“Ø–ª—ç—ç—Ö: –•—ç–Ω –Ω—ç–≥ –∏—Ä—ç—Ö —Ö“Ø—Ä—Ç—ç–ª session “Ø“Ø—Å–≥—ç—Ö–≥“Ø–π
        statusEl.innerText = "–¢–æ–≥–ª–æ–≥—á —Ö–∞–π–∂ –±–∞–π–Ω–∞...";

        // –•—ç–Ω –Ω—ç–≥ –æ—Ä–≤–æ–ª —Ç–æ–≥–ª–æ–æ–º “Ø“Ø—Å–≥—ç–Ω—ç
        onValue(queueRef, async (snap) => {
          const val = snap.val();
          if (val && Object.keys(val).length >= 2) {
            const players = Object.values(val).map(p => p.playerId);
            if (players.includes(playerId)) {
              // Session “Ø“Ø—Å–≥—ç—Ö
              await createGame(players);
              remove(queueRef);
            }
          }
        });
      } else {
        // –•–æ—ë—Ä –¥–∞—Ö—å —Ç–æ–≥–ª–æ–≥—á
        const firstPlayerKey = Object.keys(queue)[0];
        const firstPlayerId = queue[firstPlayerKey].playerId;

        if (firstPlayerId === playerId) {
          statusEl.innerText = "–¢–æ–≥–ª–æ–≥—á —Ö–∞–π–∂ –±–∞–π–Ω–∞...";
          return;
        }

        // ”®”©—Ä–∏–π–≥”©”© –Ω—ç–º–Ω—ç
        const newQueueRef = push(queueRef);
        await set(newQueueRef, { playerId });

        // –¢–æ–≥–ª–æ–æ–º “Ø“Ø—Å–≥—ç–Ω—ç
        const players = [firstPlayerId, playerId];
        await createGame(players);

        // Queue —Ö–æ–æ—Å–ª–æ—Ö
        remove(queueRef);
      }
    }

    // –¢–æ–≥–ª–æ–æ–º “Ø“Ø—Å–≥—ç—Ö
    async function createGame(players) {
      gameId = players.sort().join("_");
      isPlayer1 = players[0] === playerId;

      const gameRef = ref(db, "games/" + gameId);
      await set(gameRef, {
        players: {
          [players[0]]: null,
          [players[1]]: null
        }
      });

      statusEl.innerText = "–¢–æ–≥–ª–æ–≥—á –æ–ª–¥–ª–æ–æ! –°–æ–Ω–≥–æ–ª—Ç–æ–æ —Ö–∏–π–≥—ç—ç—Ä—ç–π.";
      choicesEl.style.display = "block";

      // –¢–æ–≥–ª–æ–æ–º—ã–≥ —Å–æ–Ω—Å–æ—Ö
      onValue(gameRef, (snap) => {
        const val = snap.val();
        if (!val) return;
        const p1Choice = val.players[players[0]];
        const p2Choice = val.players[players[1]];

        if (p1Choice && p2Choice) {
          showResult(p1Choice, p2Choice);
          remove(gameRef);
        }
      });
    }

    // –°–æ–Ω–≥–æ–ª—Ç –∏–ª–≥—ç—ç—Ö
    async function sendChoice(choice) {
      if (!gameId) return;
      const gameRef = ref(db, "games/" + gameId + "/players/" + playerId);
      await set(gameRef, choice);
      statusEl.innerText = "–ù”©–≥”©”© —Ç–æ–≥–ª–æ–≥—á–∏–π–Ω —Å–æ–Ω–≥–æ–ª—Ç—ã–≥ —Ö“Ø–ª—ç—ç–∂ –±–∞–π–Ω–∞...";
      choicesEl.style.display = "none";
    }

    // “Æ—Ä –¥“Ø–Ω —Ö–∞—Ä—É—É–ª–∞—Ö
    function showResult(p1Choice, p2Choice) {
      const resultText = getResult(p1Choice, p2Choice);
      const emojis = { rock: "ü™®", paper: "üìÑ", scissors: "‚úÇÔ∏è" };
      statusEl.innerHTML = `–¢–æ–≥–ª–æ–æ–º –¥—É—É—Å–ª–∞–∞!<br>–¢–æ–≥–ª–æ–≥—á 1: ${emojis[p1Choice]} - –¢–æ–≥–ª–æ–≥—á 2: ${emojis[p2Choice]}`;
      resultEl.innerText = resultText;
    }

    // –Ø–ª–∞–≥—á–∏–π–≥ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö
    function getResult(p1, p2) {
      if (p1 === p2) return "–¢—ç–Ω—Ü—Å—ç–Ω";
      if (
        (p1 === "scissors" && p2 === "paper") ||
        (p1 === "rock" && p2 === "scissors") ||
        (p1 === "paper" && p2 === "rock")
      ) return isPlayer1 ? "–ß–∏ —Ö–æ–∂–ª–æ–æ!" : "–ß–∏ —Ö–æ–∂–∏–≥–¥–ª–æ–æ!";
      else return isPlayer1 ? "–ß–∏ —Ö–æ–∂–∏–≥–¥–ª–æ–æ!" : "–ß–∏ —Ö–æ–∂–ª–æ–æ!";
    }

    // –¢–æ–≥–ª–æ–æ–º —ç—Ö–ª“Ø“Ø–ª—ç—Ö —Ç–æ–≤—á–ª—É—É—Ä—É—É–¥—ã–≥ —Ö–æ–ª–±–æ—Ö
    choicesEl.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", () => sendChoice(btn.getAttribute("data-choice")));
    });

    // –•–∞–π–ª—Ç —ç—Ö–ª“Ø“Ø–ª—ç—Ö
    findGame();
  </script>
</body>
</html>
